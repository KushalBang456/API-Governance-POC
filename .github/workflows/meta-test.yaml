name: üõ°Ô∏è Meta-Test Governance Logic

on:
  # Trigger on every push to any branch
  push:

  # Trigger on every PR to any branch
  pull_request:

  # Optional: Keep manual trigger for easy testing
  workflow_dispatch:

jobs:
  test-governance-logic:
    runs-on: ubuntu-latest
    steps:
      # ---------------------------------------------------------
      # 1. Checkout the Hub Repo
      # ---------------------------------------------------------
      - name: Checkout Hub
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2. Setup Environment
      # ---------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: '18' }
      - name: Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.x' }

      # ---------------------------------------------------------
      # 3. Install Dependencies
      # ---------------------------------------------------------
      - name: Install Dependencies
        run: |
          npm install openapi-diff @stoplight/spectral-cli
          pip install PyYAML

# ========================================================
      # SCENARIO: ROBUST MIX (The Ultimate Test)
      # Tests: 
      # 1. Modifying Legacy GET -> IGNORE
      # 2. Adding Legacy POST   -> INCLUDE
      # 3. Modifying Modern GET -> INCLUDE
      # 4. Adding Modern POST   -> INCLUDE
      # 5. Adding New Path      -> INCLUDE
      # ========================================================
      - name: üß™ Run Robust Mix Test
        run: |
          echo "--- 1. Generating Diff ---"
          node -e "
            const fs = require('fs'); const diff = require('openapi-diff');
            const oldSpec = fs.readFileSync('tests/main.yaml', 'utf8');
            const newSpec = fs.readFileSync('tests/pr_robust_mix.yaml', 'utf8');
            diff.diffSpecs({ sourceSpec: { content: oldSpec, location: 'old', format: 'openapi3' }, destinationSpec: { content: newSpec, location: 'new', format: 'openapi3' } })
            .then(res => fs.writeFileSync('diff.json', JSON.stringify(res, null, 2)));
          "
          
          # Setup simulation files
          cp tests/pr_robust_mix.yaml swagger_head.yaml
          cp tests/main.yaml swagger_main.yaml

          echo "--- 2. Running Generator Script ---"
          python scripts/generate_partial_spec.py "tests/baseline.yaml"

          echo "üîç DEBUG: CONTENT OF PARTIAL_SPEC.JSON"
          cat partial_spec.json
          echo "--------------------------------------"

          echo "--- 3. Verifying Logic (Assertions) ---"
          
          # A. Check Legacy Modification (GET /legacy/users should be IGNORED)
          # We check if the 'get' method exists under /legacy/users
          if grep -q '"/legacy/users"' partial_spec.json && grep -A 5 '"/legacy/users"' partial_spec.json | grep -q '"get"'; then
             echo "‚ùå FAILURE: Modified Legacy GET was incorrectly included!"
             exit 1
          fi

          # B. Check Legacy New Method (POST /legacy/users should be INCLUDED)
          if ! grep -q '"/legacy/users"' partial_spec.json || ! grep -A 5 '"/legacy/users"' partial_spec.json | grep -q '"post"'; then
             echo "‚ùå FAILURE: New method on Legacy path was skipped!"
             exit 1
          fi

          # C. Check Modern (POST /modern/orders should be INCLUDED)
          if ! grep -q '"/modern/orders"' partial_spec.json; then
             echo "‚ùå FAILURE: Modern endpoint was skipped!"
             exit 1
          fi

          # D. Check New Inclusion (POST /new/broken should be INCLUDED)
          if ! grep -q '"/new/broken"' partial_spec.json; then
             echo "‚ùå FAILURE: New endpoint was skipped!"
             exit 1
          fi

          echo "‚úÖ LOGIC PASSED: Partial spec contents are correct."

          echo "--- 4. Running Spectral (Expect FAILURE) ---"
          # We expect failure because the new POST methods have no descriptions
          if ! npx spectral lint partial_spec.json --ruleset .spectral.yaml; then
            echo "‚úÖ SUCCESS: Pipeline correctly blocked the bad code."
          else
            echo "‚ùå FAILURE: Pipeline let bad code through!"
            exit 1
          fi