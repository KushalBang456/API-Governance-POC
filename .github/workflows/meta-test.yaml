name: üõ°Ô∏è Meta-Test Governance Logic

on:
  # Trigger on every push to any branch
  push:

  # Trigger on every PR to any branch
  pull_request:

  # Optional: Keep manual trigger for easy testing
  workflow_dispatch:

jobs:
  test-governance-logic:
    runs-on: ubuntu-latest
    steps:
      # ---------------------------------------------------------
      # 1. Checkout the Hub Repo
      # ---------------------------------------------------------
      - name: Checkout Hub
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2. Setup Environment
      # ---------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: '18' }
      - name: Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.x' }

      # ---------------------------------------------------------
      # 3. Install Dependencies
      # ---------------------------------------------------------
      - name: Install Dependencies
        run: |
          npm install openapi-diff @stoplight/spectral-cli
          pip install PyYAML

      # ========================================================
      # SCENARIO: ROBUST MIX (With Debugging)
      # ========================================================
      - name: üß™ Run Robust Mix Test
        run: |
          echo "--- 1. Generating Diff (Main vs PR) ---"
          node -e "
            const fs = require('fs'); const diff = require('openapi-diff');
            const oldSpec = fs.readFileSync('tests/main.yaml', 'utf8');
            const newSpec = fs.readFileSync('tests/pr_robust_mix.yaml', 'utf8');
            diff.diffSpecs({ sourceSpec: { content: oldSpec, location: 'old', format: 'openapi3' }, destinationSpec: { content: newSpec, location: 'new', format: 'openapi3' } })
            .then(res => fs.writeFileSync('diff.json', JSON.stringify(res, null, 2)));
          "
          
          echo "üîç DEBUG: CONTENT OF DIFF.JSON"
          cat diff.json
          echo "--------------------------------"

          # Setup simulation files
          cp tests/pr_robust_mix.yaml swagger_head.yaml
          cp tests/main.yaml swagger_main.yaml

          echo "--- 2. Running Generator Script ---"
          python scripts/generate_partial_spec.py "tests/baseline.yaml"

          echo "üîç DEBUG: CONTENT OF PARTIAL_SPEC.JSON"
          cat partial_spec.json
          echo "--------------------------------------"

          echo "--- 3. Verifying Logic (Assertions) ---"
          
          # A. Check Legacy Filtering
          if grep -q "/legacy/users" partial_spec.json; then
             echo "‚ùå FAILURE: Legacy endpoint was incorrectly included!"
             exit 1
          fi

          # B. Check Modern Inclusion
          if ! grep -q "/modern/orders" partial_spec.json; then
             echo "‚ùå FAILURE: Modified modern endpoint was skipped!"
             exit 1
          fi

          # C. Check New Inclusion
          if ! grep -q "/new/broken" partial_spec.json; then
             echo "‚ùå FAILURE: New endpoint was skipped!"
             exit 1
          fi

          # D. Check Schema Copying
          if ! grep -q "Leaf" partial_spec.json; then
             echo "‚ùå FAILURE: Transitive schema 'Leaf' missing!"
             exit 1
          fi

          echo "‚úÖ LOGIC PASSED: Partial spec contents are correct."

          echo "--- 4. Running Spectral (Expect FAILURE) ---"
          if ! npx spectral lint partial_spec.json --ruleset .spectral.yaml; then
            echo "‚úÖ SUCCESS: Pipeline correctly blocked the bad code."
          else
            echo "‚ùå FAILURE: Pipeline let bad code through!"
            exit 1
          fi