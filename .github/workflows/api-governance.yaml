name: API Governance Template

on:
  workflow_call:
    inputs:
      SlnFile:
        required: true
        type: string
      ProjectFile:
        required: true
        type: string
      ProjectAssemblyName:
        required: true
        type: string
      TargetFramework:
        required: true
        type: string
      SwashbuckleVersion:
        required: true
        type: string
      SwaggerDocName:
        required: true
        type: string
      BaselinePackageName:
        required: true
        type: string
      DefaultTargetBranch:
        required: false
        type: string
        default: 'main'

jobs:
  api-governance:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      # Checkout the spoke repository (the repo calling this workflow)
      - name: Checkout spoke repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: spoke-repo
      
      # Checkout the hub repository (this governance repo)
      - name: Checkout governance repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/API_Governance
          path: governance-repo
      
      # ---------------------------
      # 1. Generate swagger_head.json (from PR branch)
      # ---------------------------
      - name: Generate OpenAPI spec (PR Branch)
        shell: pwsh
        working-directory: spoke-repo
        run: |
          ./generate-spec.ps1 `
            -OutputFile ${{ runner.temp }}/swagger_head.json `
            -SlnFile "${{ inputs.SlnFile }}" `
            -ProjectFile "${{ inputs.ProjectFile }}" `
            -ProjectAssemblyName "${{ inputs.ProjectAssemblyName }}" `
            -TargetFramework "${{ inputs.TargetFramework }}" `
            -SwashbuckleVersion "${{ inputs.SwashbuckleVersion }}" `
            -SwaggerDocName "${{ inputs.SwaggerDocName }}"
      
      # ---------------------------
      # 2. Checkout target branch and generate swagger_main.json
      # ---------------------------
      - name: Checkout target branch
        shell: pwsh
        working-directory: spoke-repo
        run: |
          $targetBranch = if ("${{ github.event_name }}" -eq "pull_request") {
            "${{ github.base_ref }}"
          } else {
            "${{ inputs.DefaultTargetBranch }}"
          }
          
          Write-Host "üéØ Checkout Target Branch: $targetBranch"
          git fetch origin $targetBranch
          git checkout $targetBranch
      
      - name: Generate OpenAPI spec (Target Branch)
        shell: pwsh
        working-directory: spoke-repo
        run: |
          ./generate-spec.ps1 `
            -OutputFile ${{ runner.temp }}/swagger_main.json `
            -SlnFile "${{ inputs.SlnFile }}" `
            -ProjectFile "${{ inputs.ProjectFile }}" `
            -ProjectAssemblyName "${{ inputs.ProjectAssemblyName }}" `
            -TargetFramework "${{ inputs.TargetFramework }}" `
            -SwashbuckleVersion "${{ inputs.SwashbuckleVersion }}" `
            -SwaggerDocName "${{ inputs.SwaggerDocName }}"
      
      - name: Show workspace contents
        shell: pwsh
        run: |
          Write-Host "=== Folder layout ==="
          Get-ChildItem -Path "${{ github.workspace }}" -Recurse | Select-Object FullName
      
      # ---------------------------
      # 3. Install diff tools
      # ---------------------------
      - name: Install OpenAPI Diff
        run: |
          echo "Installing OpenAPI Diff tool..."
          npm install -g openapi-diff
      
      # ---------------------------
      # 4. Run OpenAPI Diff
      # ---------------------------
      - name: Generate OpenAPI Diff
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $swaggerMainSource = "${{ runner.temp }}/swagger_main.json"
          $swaggerHeadSource = "${{ runner.temp }}/swagger_head.json"
          $diffOutput = "${{ runner.temp }}/diff.json"

          if (-not (Test-Path $swaggerMainSource)) { 
            Write-Error "‚ùå swagger_main.json not found!"
            exit 1 
          }
          if (-not (Test-Path $swaggerHeadSource)) { 
            Write-Error "‚ùå swagger_head.json not found!"
            exit 1 
          }

          Copy-Item -Path $swaggerMainSource -Destination "./swagger_main.json" -Force
          Copy-Item -Path $swaggerHeadSource -Destination "./swagger_head.json" -Force
          
          Write-Host "Running OpenAPI Diff..."
          & openapi-diff ./swagger_main.json ./swagger_head.json | Out-File -FilePath $diffOutput -Encoding utf8
          
          Write-Host "‚úÖ OpenAPI Diff written to: $diffOutput"
          Get-Content $diffOutput | Write-Host
      
      # ---------------------------
      # 5. Download baseline from GitHub Releases
      # ---------------------------
      - name: Download API baseline from GitHub Releases
        shell: pwsh
        run: |
          $repoOwner = "${{ github.repository_owner }}"
          $repoName = "API_Governance"
          $packageName = "${{ inputs.BaselinePackageName }}"
          $version = "1.0.0"
          $downloadDir = "${{ runner.temp }}/baseline_package"
          
          Write-Host "Downloading baseline '$packageName' version $version..."
          
          # Use GitHub CLI to download release asset
          $releaseTag = "baseline-$packageName-v$version"
          $assetName = "$packageName.json"
          
          # Create download directory
          New-Item -ItemType Directory -Path $downloadDir -Force | Out-Null
          
          # Download using GitHub API
          $headers = @{
            Authorization = "Bearer ${{ github.token }}"
            Accept = "application/vnd.github+json"
          }
          
          try {
            # Get release by tag
            $releaseUrl = "https://api.github.com/repos/$repoOwner/$repoName/releases/tags/$releaseTag"
            $release = Invoke-RestMethod -Uri $releaseUrl -Headers $headers
            
            # Find the asset
            $asset = $release.assets | Where-Object { $_.name -eq $assetName }
            if (-not $asset) {
              Write-Error "‚ùå Asset '$assetName' not found in release '$releaseTag'"
              exit 1
            }
            
            # Download the asset
            $assetUrl = $asset.url
            Invoke-RestMethod -Uri $assetUrl -Headers $headers -OutFile "$downloadDir/$assetName"
            Write-Host "‚úÖ Successfully downloaded baseline to $downloadDir/$assetName"
          } catch {
            Write-Error "‚ùå Failed to download baseline: $($_.Exception.Message)"
            exit 1
          }
      
      - name: Rename baseline file
        shell: pwsh
        run: |
          $file = Get-ChildItem -Path "${{ runner.temp }}/baseline_package" -Filter "*.json" | Select-Object -First 1
          
          if ($file) {
            $newPath = "${{ runner.temp }}/swagger_baseline.json"
            Move-Item -Path $file.FullName -Destination $newPath -Force
            Write-Host "‚úÖ Moved and renamed baseline to: $newPath"
          } else {
            Write-Error "‚ùå Could not find a downloaded baseline JSON file"
            exit 1
          }
      
      # ---------------------------
      # 6. Generate Partial Spec (Python)
      # ---------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Create Partial OpenAPI Spec from Diff
        run: python governance-repo/scripts/generate_partial_spec.py
        env:
          BUILD_ARTIFACTSTAGINGDIRECTORY: ${{ runner.temp }}
          PIPELINE_WORKSPACE: ${{ runner.temp }}
      
      # ---------------------------
      # 7. PASS 1: Lint Partial Spec (Strict - Errors)
      # ---------------------------
      - name: 'PASS 1: Lint Partial Spec (Strict) & Post Errors'
        shell: pwsh
        run: |
          governance-repo/scripts/post_spectral_comments.ps1 `
            -SpecFile ${{ runner.temp }}/partial_spec.json `
            -RulesetFile governance-repo/.spectral.yaml `
            -TaskID Strict `
            -TaskTitle "NB Governance üõë Strict Checks (New Code)"
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_API_URL: ${{ github.api_url }}
          RUNNER_TEMP: ${{ runner.temp }}
      
      # ---------------------------
      # 8. PASS 2: Lint Full Spec (Advisory - Warnings)
      # ---------------------------
      - name: 'PASS 2: Lint Full Spec (Advisory) & Post Warnings'
        if: always()
        shell: pwsh
        run: |
          governance-repo/scripts/post_spectral_comments.ps1 `
            -SpecFile ${{ runner.temp }}/swagger_head.json `
            -RulesetFile governance-repo/.spectral-loose.yaml `
            -TaskID Advisory `
            -TaskTitle "NB Governance ‚ö†Ô∏è Advisory Checks (Full Spec)"
        env:
          GITHUB_TOKEN: ${{ github.token }}
          GITHUB_WORKSPACE: ${{ github.workspace }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_API_URL: ${{ github.api_url }}
          RUNNER_TEMP: ${{ runner.temp }}
