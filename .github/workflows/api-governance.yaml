# name: API Governance Template

# on:
#   workflow_call:
#     inputs:
#       SlnFile:
#         required: true
#         type: string
#       ProjectFile:
#         required: true
#         type: string
#       ProjectAssemblyName:
#         required: true
#         type: string
#       TargetFramework:
#         required: true
#         type: string
#       SwashbuckleVersion:
#         required: true
#         type: string
#       SwaggerDocName:
#         required: true
#         type: string
#       BaselinePackageName:
#         required: true
#         type: string
#       DefaultTargetBranch:
#         required: false
#         type: string
#         default: 'main'

# jobs:
#   api-governance:
#     runs-on: ubuntu-latest
    
#     permissions:
#       contents: read
#       pull-requests: write
    
#     steps:
#       # Checkout the spoke repository (the repo calling this workflow)
#       - name: Checkout spoke repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
#           path: spoke-repo
      
#       # Checkout the hub repository (this governance repo)
#       - name: Checkout governance repository
#         uses: actions/checkout@v4
#         with:
#           repository: ${{ github.repository_owner }}/API_Governance
#           path: governance-repo
      
#       # ---------------------------
#       # 1. Generate swagger_head.json (from PR branch)
#       # ---------------------------
#       - name: Generate OpenAPI spec (PR Branch)
#         shell: pwsh
#         working-directory: spoke-repo
#         run: |
#           ./generate-spec.ps1 `
#             -OutputFile ${{ runner.temp }}/swagger_head.json `
#             -SlnFile "${{ inputs.SlnFile }}" `
#             -ProjectFile "${{ inputs.ProjectFile }}" `
#             -ProjectAssemblyName "${{ inputs.ProjectAssemblyName }}" `
#             -TargetFramework "${{ inputs.TargetFramework }}" `
#             -SwashbuckleVersion "${{ inputs.SwashbuckleVersion }}" `
#             -SwaggerDocName "${{ inputs.SwaggerDocName }}"
      
#       # ---------------------------
#       # 2. Checkout target branch and generate swagger_main.json
#       # ---------------------------
#       - name: Checkout target branch
#         shell: pwsh
#         working-directory: spoke-repo
#         run: |
#           $targetBranch = if ("${{ github.event_name }}" -eq "pull_request") {
#             "${{ github.base_ref }}"
#           } else {
#             "${{ inputs.DefaultTargetBranch }}"
#           }
          
#           Write-Host "üéØ Checkout Target Branch: $targetBranch"
#           git fetch origin $targetBranch
#           git checkout $targetBranch
      
#       - name: Generate OpenAPI spec (Target Branch)
#         shell: pwsh
#         working-directory: spoke-repo
#         run: |
#           ./generate-spec.ps1 `
#             -OutputFile ${{ runner.temp }}/swagger_main.json `
#             -SlnFile "${{ inputs.SlnFile }}" `
#             -ProjectFile "${{ inputs.ProjectFile }}" `
#             -ProjectAssemblyName "${{ inputs.ProjectAssemblyName }}" `
#             -TargetFramework "${{ inputs.TargetFramework }}" `
#             -SwashbuckleVersion "${{ inputs.SwashbuckleVersion }}" `
#             -SwaggerDocName "${{ inputs.SwaggerDocName }}"
      
#       - name: Show workspace contents
#         shell: pwsh
#         run: |
#           Write-Host "=== Folder layout ==="
#           Get-ChildItem -Path "${{ github.workspace }}" -Recurse | Select-Object FullName
      
#       # ---------------------------
#       # 3. Install diff tools
#       # ---------------------------
#       - name: Install OpenAPI Diff
#         run: |
#           echo "Installing OpenAPI Diff tool..."
#           npm install -g openapi-diff
      
#       # ---------------------------
#       # 4. Run OpenAPI Diff
#       # ---------------------------
#       - name: Generate OpenAPI Diff
#         shell: pwsh
#         run: |
#           $ErrorActionPreference = 'Stop'
#           $swaggerMainSource = "${{ runner.temp }}/swagger_main.json"
#           $swaggerHeadSource = "${{ runner.temp }}/swagger_head.json"
#           $diffOutput = "${{ runner.temp }}/diff.json"

#           if (-not (Test-Path $swaggerMainSource)) { 
#             Write-Error "‚ùå swagger_main.json not found!"
#             exit 1 
#           }
#           if (-not (Test-Path $swaggerHeadSource)) { 
#             Write-Error "‚ùå swagger_head.json not found!"
#             exit 1 
#           }

#           Copy-Item -Path $swaggerMainSource -Destination "./swagger_main.json" -Force
#           Copy-Item -Path $swaggerHeadSource -Destination "./swagger_head.json" -Force
          
#           Write-Host "Running OpenAPI Diff..."
#           & openapi-diff ./swagger_main.json ./swagger_head.json | Out-File -FilePath $diffOutput -Encoding utf8
          
#           Write-Host "‚úÖ OpenAPI Diff written to: $diffOutput"
#           Get-Content $diffOutput | Write-Host
      
#       # ---------------------------
#       # 5. Download baseline from GitHub Releases
#       # ---------------------------
#       - name: Download API baseline from GitHub Releases
#         shell: pwsh
#         run: |
#           $repoOwner = "${{ github.repository_owner }}"
#           $repoName = "API_Governance"
#           $packageName = "${{ inputs.BaselinePackageName }}"
#           $version = "1.0.0"
#           $downloadDir = "${{ runner.temp }}/baseline_package"
          
#           Write-Host "Downloading baseline '$packageName' version $version..."
          
#           # Use GitHub CLI to download release asset
#           $releaseTag = "baseline-$packageName-v$version"
#           $assetName = "$packageName.json"
          
#           # Create download directory
#           New-Item -ItemType Directory -Path $downloadDir -Force | Out-Null
          
#           # Download using GitHub API
#           $headers = @{
#             Authorization = "Bearer ${{ github.token }}"
#             Accept = "application/vnd.github+json"
#           }
          
#           try {
#             # Get release by tag
#             $releaseUrl = "https://api.github.com/repos/$repoOwner/$repoName/releases/tags/$releaseTag"
#             $release = Invoke-RestMethod -Uri $releaseUrl -Headers $headers
            
#             # Find the asset
#             $asset = $release.assets | Where-Object { $_.name -eq $assetName }
#             if (-not $asset) {
#               Write-Error "‚ùå Asset '$assetName' not found in release '$releaseTag'"
#               exit 1
#             }
            
#             # Download the asset
#             $assetUrl = $asset.url
#             Invoke-RestMethod -Uri $assetUrl -Headers $headers -OutFile "$downloadDir/$assetName"
#             Write-Host "‚úÖ Successfully downloaded baseline to $downloadDir/$assetName"
#           } catch {
#             Write-Error "‚ùå Failed to download baseline: $($_.Exception.Message)"
#             exit 1
#           }
      
#       - name: Rename baseline file
#         shell: pwsh
#         run: |
#           $file = Get-ChildItem -Path "${{ runner.temp }}/baseline_package" -Filter "*.json" | Select-Object -First 1
          
#           if ($file) {
#             $newPath = "${{ runner.temp }}/swagger_baseline.json"
#             Move-Item -Path $file.FullName -Destination $newPath -Force
#             Write-Host "‚úÖ Moved and renamed baseline to: $newPath"
#           } else {
#             Write-Error "‚ùå Could not find a downloaded baseline JSON file"
#             exit 1
#           }
      
#       # ---------------------------
#       # 6. Generate Partial Spec (Python)
#       # ---------------------------
#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.x'
      
#       - name: Create Partial OpenAPI Spec from Diff
#         run: python governance-repo/scripts/generate_partial_spec.py
#         env:
#           BUILD_ARTIFACTSTAGINGDIRECTORY: ${{ runner.temp }}
#           PIPELINE_WORKSPACE: ${{ runner.temp }}
      
#       # ---------------------------
#       # 7. PASS 1: Lint Partial Spec (Strict - Errors)
#       # ---------------------------
#       - name: 'PASS 1: Lint Partial Spec (Strict) & Post Errors'
#         shell: pwsh
#         run: |
#           governance-repo/scripts/post_spectral_comments.ps1 `
#             -SpecFile ${{ runner.temp }}/partial_spec.json `
#             -RulesetFile governance-repo/.spectral.yaml `
#             -TaskID Strict `
#             -TaskTitle "NB Governance üõë Strict Checks (New Code)"
#         env:
#           GITHUB_TOKEN: ${{ github.token }}
#           GITHUB_WORKSPACE: ${{ github.workspace }}
#           GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
#           GITHUB_REPOSITORY: ${{ github.repository }}
#           GITHUB_API_URL: ${{ github.api_url }}
#           RUNNER_TEMP: ${{ runner.temp }}
      
#       # ---------------------------
#       # 8. PASS 2: Lint Full Spec (Advisory - Warnings)
#       # ---------------------------
#       - name: 'PASS 2: Lint Full Spec (Advisory) & Post Warnings'
#         if: always()
#         shell: pwsh
#         run: |
#           governance-repo/scripts/post_spectral_comments.ps1 `
#             -SpecFile ${{ runner.temp }}/swagger_head.json `
#             -RulesetFile governance-repo/.spectral-loose.yaml `
#             -TaskID Advisory `
#             -TaskTitle "NB Governance ‚ö†Ô∏è Advisory Checks (Full Spec)"
#         env:
#           GITHUB_TOKEN: ${{ github.token }}
#           GITHUB_WORKSPACE: ${{ github.workspace }}
#           GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
#           GITHUB_REPOSITORY: ${{ github.repository }}
#           GITHUB_API_URL: ${{ github.api_url }}
#           RUNNER_TEMP: ${{ runner.temp }}


name: API Governance Engine

# 1. --- Define Inputs ---
on:
  workflow_call:
    inputs:
      swagger_path:
        required: true
        type: string
        description: "Path to the swagger file in the spoke repo (e.g. swagger.yaml)"
      baseline_filename:
        required: true
        type: string
        description: "Name of the baseline file in the Release (e.g. javatest-legacy.yaml)"
      baseline_version:
        required: false
        type: string
        default: 'baselines-v1'
        description: "The Release Tag to download from"

jobs:
  governance-engine:
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required to download releases
    
    steps:
      # ---------------------------------------------------------
      # 1. Checkout Repositories
      # ---------------------------------------------------------
      - name: Checkout Spoke Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for history

      - name: Checkout Governance Hub
        uses: actions/checkout@v4
        with:
          repository: KushalBang456/API-Governance-POC
          path: governance-hub

      # ---------------------------------------------------------
      # 2. Setup Environment (MISSING IN YOUR SNIPPET)
      # ---------------------------------------------------------
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # ---------------------------------------------------------
      # 3. Install Dependencies
      # ---------------------------------------------------------
      - name: Install Dependencies
        run: |
          npm install -g @stoplight/spectral-cli
          pip install PyYAML

      # ---------------------------------------------------------
      # 4. Prepare Specs (Extract HEAD and TARGET versions)
      # ---------------------------------------------------------
      - name: Prepare Specs
        run: |
          echo "üìç Processing Swagger: ${{ inputs.swagger_path }}"
          
          # A. Capture Filename & Extension
          INPUT_FILE="${{ inputs.swagger_path }}"
          EXT="${INPUT_FILE##*.}"
          
          # B. Determine Target Branch (Dynamic)
          TARGET_BRANCH="${{ github.base_ref }}"
          if [ -z "$TARGET_BRANCH" ]; then
            TARGET_BRANCH="main"
            echo "‚ö†Ô∏è Manual Trigger detected. Defaulting target to 'main'."
          fi

          # 1. Get HEAD version (Current file)
          if [ -f "$INPUT_FILE" ]; then
             cp "$INPUT_FILE" "swagger_head.$EXT"
          else
             echo "‚ùå Error: Swagger file not found at $INPUT_FILE"
             exit 1
          fi
          
          # 2. Get TARGET version (Base Branch)
          echo "Fetching version from origin/$TARGET_BRANCH..."
          git show "origin/$TARGET_BRANCH:$INPUT_FILE" > "swagger_main.$EXT"
          
          echo "‚úÖ Extracted Head and Main specs."

      # ---------------------------------------------------------
      # 5. Download Baseline
      # ---------------------------------------------------------
      - name: ‚¨áÔ∏è Download Baseline from GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching ${{ inputs.baseline_filename }} from tag ${{ inputs.baseline_version }}..."
          gh release download ${{ inputs.baseline_version }} \
            --repo KushalBang456/API-Governance-POC \
            --pattern "${{ inputs.baseline_filename }}"

      # ---------------------------------------------------------
      # 6. Generate Diff
      # ---------------------------------------------------------
      - name: Generate Diff
        run: |
          # 1. Detect extension
          INPUT="${{ inputs.swagger_path }}"
          EXT="${INPUT##*.}"
          
          echo "üîç Generating diff between swagger_main.$EXT and swagger_head.$EXT..."
          
          # 2. Run the Official Java Tool via Docker
          # We mount the current directory ($PWD) to /specs inside the container
          # We tell it to output JSON to diff.json
          docker run --rm \
            -v "$PWD":/specs \
            openapitools/openapi-diff:latest \
            --json /specs/diff.json \
            /specs/swagger_main.$EXT /specs/swagger_head.$EXT
          
          # 3. Verify it worked
          if [ -f "diff.json" ]; then
            echo "‚úÖ Diff generated successfully."
          else
            echo "‚ùå Failed to generate diff.json"
            exit 1
          fi

      # ---------------------------------------------------------
      # 7. Run Logic (Python)
      # ---------------------------------------------------------
      - name: Generate Partial Spec
        run: |
          python governance-hub/scripts/generate_partial_spec.py "${{ inputs.baseline_filename }}"

      # ---------------------------------------------------------
      # 8. Linting (Strict)
      # ---------------------------------------------------------
      - name: üõë Strict Lint (Blocks PR)
        run: |
          npx spectral lint partial_spec.json \
            --ruleset governance-hub/.spectral.yaml \
            --format stylish

      # ---------------------------------------------------------
      # 9. Linting (Advisory)
      # ---------------------------------------------------------
      - name: ‚ö†Ô∏è Advisory Lint (Tech Debt)
        continue-on-error: true
        run: |
          INPUT="${{ inputs.swagger_path }}"
          EXT="${INPUT##*.}"
          
          npx spectral lint "swagger_head.$EXT" \
            --ruleset governance-hub/.spectral-warn.yaml \
            --format stylish